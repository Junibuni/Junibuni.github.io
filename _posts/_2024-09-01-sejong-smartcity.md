---

title: Shallow Water Equation AI 모델 구현 - 스마트 시티 침수 예측 
date: 2024-09-01 12:43:00 +0800 
categories: [AI, Fluid Dynamics] 
tags: [shallow water equation, ai model, cfd, computer vision, image processing, deep learning, neural networks, python, pytorch, fluid simulation, machine learning, lstm, autoencoder, sph, urban flooding] 
use_math: true
---
# 스마트 시티 침수 예측: Shallow Water Equation과 AI 모델을 활용한 해결 방법

## 서론
물리 기반 시뮬레이션은 수치 해석 기법을 통해 자연 현상이나 물리적 시스템을 정밀하게 예측하는 데 중요한 역할을 한다. 특히, 스마트 시티와 같은 도시 환경에서 침수 문제는 기후 변화로 인한 집중 호우와 같은 극단적인 기상 현상에서 발생할 수 있으며, 실시간으로 대응해야 하는 중요한 문제이다. 기존의 수치 해석 기법은 높은 정확도를 제공하지만, 복잡한 계산으로 인해 실시간 예측에는 한계가 있다. 본 프로젝트에서는 이러한 문제를 해결하기 위해 AI 기술을 도입하여, 빠르고 정확한 침수 예측을 목표로 하고 있다.

스마트 시티는 다양한 센서와 데이터 기반의 인프라를 통해 도시 관리와 예측을 최적화하는 시스템을 의미한다. 그러나, 지형의 특성이나 인프라의 복잡성으로 인해 집중 호우 시 침수나 역류 현상이 발생할 수 있다. 특히, 맨홀에서 발생하는 역류는 도시의 하수 시스템을 마비시키고, 침수 범람을 가속화하여 도로, 지하철, 건물에 심각한 피해를 줄 수 있다. 이러한 상황에서는 빠르고 정확한 침수 예측이 필수적이며, 기존 물리 기반 해석기법은 한계가 명확히 존재한다.

[ANUGA](https://anuga.readthedocs.io/en/latest/)와 같은 수치 해석기는 천수 방정식(Shallow Water Equation)을 기반으로 스마트 시티 환경에서의 침수 예측을 수행할 수 있다. 천수 방정식은 물의 깊이 및 x, y 방향의 모멘텀을 계산하여 물의 흐름을 예측하는 방정식으로, 도시의 수리학적 문제를 해결하는 데 널리 사용되고 있다. 그러나, ANUGA와 같은 수치 해석기를 사용한 시뮬레이션은 한 케이스당 약 4시간의 계산 시간이 소요되며, 이는 실시간 대응에는 부적합한 문제를 가지고 있다.

따라서 본 프로젝트에서는 물리 기반 해석의 장점을 유지하면서도, 계산 시간을 크게 단축할 수 있는 AI 기반 예측 모델을 개발하고자 했다. 특히, 침수 범람 시 주요 변수인 맨홀 역류량과 같은 추가 변수를 고려하여 예측 정확도를 높이는 데 중점을 두었다. AI 모델은 Autoencoder와 LSTM을 결합하여 잠재 벡터를 통해 시계열 데이터로 침수 현상을 예측하도록 설계되었으며, 이를 통해 실시간 예측이 가능한 모델을 구현하고자 했다.

## 프로젝트 목표 및 개요

<img src="{{page.img_pth}}smartcity.png">
이 프로젝트의 목표는 AutoEncoder를 활용해 스마트시티의 침수 해석을 경량화하고, 실시간 예측이 가능한 해석 솔버를 개발하는 것입니다. 특히 스마트시티 내 J01, J02, J03, J03-06, J06, J08-09 맨홀의 역류 상황을 예측할 수 있는 모델을 구축하였으며, 다양한 물리적 변수를 학습하여 효율적으로 압축된 **잠재 벡터(latent vector)**를 생성하는 AutoEncoder 모델을 구현하였습니다.

이를 통해, 3D 3채널 이미지(물의 깊이, x와 y 방향 모멘텀)를 입력받아, 물의 수위를 2D 이미지 형태로 예측할 수 있도록 설계되었습니다.

## 모델 구현 방법

이번 프로젝트의 핵심은 AI 모델을 통해 스마트 시티 환경에서 침수 예측의 속도와 효율성을 극대화하는 것이다. 이를 위해 **Autoencoder**와 **LSTM(Long Short-Term Memory)** 모델을 결합하여 물리 기반 시뮬레이션의 복잡한 계산을 대체할 수 있는 예측 모델을 구현했다. 이 과정에서는 **BigBlock-SmallBlock 구조**를 도입한 Autoencoder와 시계열 데이터를 다루는 LSTM을 활용하여, 침수 현상 예측에서 중요한 물리적 특징을 효과적으로 추출하고, 이를 바탕으로 시뮬레이션을 가속화하는 데 중점을 두었다.

### 1. Autoencoder 설계

**Autoencoder**는 입력 데이터를 저차원의 잠재 벡터 (latent vector)로 압축하고, 다시 이를 원래 차원의 데이터로 복원하는 비지도 학습 모델이다. 이 모델은 복잡한 시뮬레이션 데이터를 효율적으로 압축할 수 있는 특성을 가지고 있어, **Shallow Water Equation**을 기반으로 한 물리적 데이터를 학습하는 데 적합하다고 판단했다. 

특히, 이번 프로젝트에서는 **BigBlock-SmallBlock** 아키텍처를 도입하여 Autoencoder를 설계했다. 이 구조는 다중 스케일로 데이터를 처리할 수 있는 장점을 가지며, 깊이 있는 특성 추출이 가능하기 때문이다.

- **SmallBlock**: 각 SmallBlock은 3x3 커널 크기를 가진 합성곱(convolution) 레이어와 **LeakyReLU** 활성화 함수로 구성되어 있다. SmallBlock은 각 레이어에서 데이터를 점진적으로 처리하며, 주요 특징을 추출 할 수 있다.
- **BigBlock**: 여러 개의 SmallBlock이 모여 **BigBlock**을 형성한다. BigBlock은 입력 데이터를 여러 단계로 처리하며, 각 SmallBlock에서 추출된 특징을 누적하여 최종적으로 고차원 데이터를 압축한다. BigBlock 내부에서는 입력 데이터를 매 단계에서 스킵 연결(skip connection)하여, 원래 입력 데이터와 처리된 데이터를 함께 결합하여 더욱 풍부한 정보를 학습할 수 있도록 했다.

Autoencoder의 **Encoder**는 입력 이미지(침수 현상)를 저차원의 잠재 벡터로 변환하는 역할을 한다. 이때 입력 이미지에는 물의 깊이와 x, y 방향의 모멘텀이 포함되어 있으며, 이 정보는 각각의 채널로 나뉘어 3채널 이미지 형태로 입력됩니다. 이후, 여러 개의 BigBlock을 통해 특징이 추출되고, 최종적으로 압축된 잠재 벡터가 생성된다.

**Decoder**는 이 잠재 벡터를 다시 원래 차원의 이미지로 복원하는 역할을 한다. Decoder는 Encoder와 대칭적인 구조를 가지며, 잠재 벡터를 입력받아 다시 원래 이미지로 복원한다. 이를 통해 침수 예측 시 필요한 물리적 정보를 담은 2D 이미지를 다시 생성할 수 있다.

### 2. LSTM 기반 시계열 예측 모델

Autoencoder에서 생성된 잠재 벡터는 하나의 시간 스텝에서 도메인의 상태를 나타내는 정보이다. 하지만 침수 예측에서는 시간이 흐름에 따라 상태가 변하는 시계열 데이터를 처리해야 하므로, **LSTM(Long Short-Term Memory)** 모델을 도입하여 이를 해결했다.


- **Manifold Navigation**: LSTM 모델은 현재 시점의 잠재 벡터와 추가 변수(예: 맨홀 역류량)를 입력으로 받아, 다음 시점의 잠재 벡터와의 차이를 예측합니다. 이때, LSTM의 입력으로는 현재 상태의 잠재 벡터와 각 시점에서의 **맨홀 역류량** 데이터가 결합됩니다. 이러한 방식은 물리적 현상을 더 정확하게 반영할 수 있으며, 단순히 이전 상태만을 고려하는 것이 아니라 추가 변수까지 통합하여 예측 정확도를 높일 수 있습니다.
  
  예를 들어, **현재 시점의 잠재 벡터**와 **맨홀 역류량**이 주어졌을 때, LSTM은 이를 학습하여 **다음 시점에서의 잠재 벡터 변화**를 예측하게 됩니다. 이를 통해 시계열 데이터의 흐름을 파악하고, 시간의 흐름에 따라 물리적 상태가 어떻게 변화하는지를 예측합니다.

### 3. 전체 시뮬레이션 흐름

최종적으로, Autoencoder와 LSTM을 결합한 전체 시뮬레이션 예측 과정은 다음과 같습니다:

1. **초기 상태 입력**: 시뮬레이션이 시작될 때, 2D 이미지 형태의 물의 깊이 및 모멘텀(x, y 방향)이 Autoencoder의 Encoder에 입력됩니다. 이를 통해 저차원 잠재 벡터가 생성됩니다.
  
2. **LSTM을 통한 잠재 벡터 예측**: 생성된 잠재 벡터는 LSTM 모델을 거치며, 시간의 흐름에 따라 각 시점에서 다음 상태의 잠재 벡터가 예측됩니다. 이때, **맨홀 역류량**과 같은 추가 변수도 함께 입력되어 예측의 정확도를 높입니다.

3. **Decoder를 통한 이미지 복원**: 예측된 잠재 벡터는 다시 Decoder를 통해 원래 차원의 이미지로 복원됩니다. 이를 통해 다음 시점에서의 침수 상태(물의 깊이와 x, y 모멘텀)를 예측할 수 있습니다.

4. **전체 시뮬레이션 반복**: 이 과정을 반복하여 전체 시뮬레이션 과정을 예측하며, 시뮬레이션 결과는 영상 형태로 출력될 수 있습니다. 각 시점에서의 이미지 결과가 모여 **전체 시뮬레이션 영상**이 생성됩니다.

### 4. 모델 최적화 및 문제 해결

모델 구현 과정에서는 여러 문제점들이 발생하였으나, 이를 해결하기 위해 다양한 방법을 적용하였습니다.

- **추가 변수 처리 문제**: 단순 LSTM 모델에 맨홀 역류량과 같은 추가 변수를 결합하였을 때, 모델이 이를 제대로 처리하지 못하는 문제가 발생하였습니다. 이를 해결하기 위해 **잠재 벡터와 추가 변수를 적절히 결합하는 방식**을 수정하였고, 다중 입력을 처리할 수 있는 구조로 LSTM을 개선하였습니다.
  
- **다단계 예측 문제**: LSTM을 이용한 다단계 예측(한 시점의 데이터를 입력하여 다음 시점을 예측하는 방식)이 초기 모델에서는 제대로 작동하지 않았습니다. 이에 따라, LSTM 모델의 학습 방식을 개선하고, 다단계 예측이 가능하도록 모델의 구조를 최적화하였습니다.

- **Autoencoder 학습**: Autoencoder 모델은 물리 기반 시뮬레이션에서 중요한 특징을 학습할 수 있어야 합니다. 이를 위해, 각 채널(물의 깊이, x 방향 모멘텀, y 방향 모멘텀)의 정보를 균등하게 학습하도록 모델 구조를 설계하였으며, 각 특징이 시뮬레이션 결과에 적절히 반영될 수 있도록 학습 과정을 조정하였습니다.

---

이와 같은 AI 모델의 구현을 통해, 기존의 물리 기반 시뮬레이션의 장점을 유지하면서도, 실시간 침수 예측이 가능한 시스템을 개발할 수 있었습니다.